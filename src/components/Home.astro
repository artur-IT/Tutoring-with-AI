---
import NameInput from "./NameInput";
import { PwaInstallButton } from "./PwaInstallButton";
---

<div
  class="min-h-dvh bg-linear-to-br from-background via-background to-accent/5 flex flex-col items-center justify-center p-4 py-8 md:py-12 relative"
>
  <!-- Decorative background elements -->
  <div class="absolute inset-0 -z-10 overflow-hidden">
    <div class="absolute top-20 right-10 w-64 h-64 bg-primary/5 rounded-full blur-3xl"></div>
    <div class="absolute bottom-20 left-10 w-80 h-80 bg-accent/10 rounded-full blur-3xl"></div>
  </div>

  <!-- PWA Install Button (only visible when app is installable) -->
  <PwaInstallButton client:load />

  <div class="text-center mt-2 mb-8 md:mb-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
    <div class="mb-4 text-5xl animate-[wiggle_2s_ease-in-out_infinite]">ðŸŽ“</div>
    <h1 class="text-3xl md:text-4xl lg:text-5xl font-black text-foreground mb-4 tracking-tight">
      Korepetytor <span class="text-primary">AI</span>
    </h1>
    <p class="text-base md:text-lg lg:text-xl text-muted-foreground font-medium">
      Pomoc dla uczniÃ³w liceÃ³w i technikÃ³w
    </p>
  </div>

  <NameInput client:idle />

  <!-- Content that should be inert when modal is open -->
  <div id="home-content" class="hidden flex-col items-center justify-center">
    <!-- Welcome text centered -->
    <div class="text-center my-4 md:my-8 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-150">
      <div class="mb-2 md:mb-4 text-3xl md:text-4xl">ðŸ‘‹</div>
      <h2 class="text-2xl md:text-3xl lg:text-4xl font-black text-foreground mb-4 md:mb-6">
        Witaj <span id="name-display" aria-live="polite" class="text-primary"></span>!
      </h2>
      <p class="text-base md:text-lg lg:text-xl text-muted-foreground font-medium mb-4 md:mb-8">Gotowy na naukÄ™?</p>
    </div>

    <!-- Blocked message (hidden by default) -->
    <div
      id="blocked-message"
      class="hidden w-full max-w-md mx-auto mb-6 p-4 rounded-2xl bg-destructive/10 border-2 border-destructive/30 text-center animate-in fade-in duration-500"
    >
      <div class="text-3xl mb-2">ðŸ”’</div>
      <h3 class="text-lg font-bold text-destructive mb-2">Aplikacja tymczasowo niedostÄ™pna</h3>
      <p id="blocked-message-text" class="text-sm text-muted-foreground"></p>
    </div>

    <div class="flex flex-col gap-4 items-center animate-in fade-in slide-in-from-bottom-4 duration-700 delay-300">
      <a
        id="start-button"
        href="/tutors"
        class="w-46 inline-flex items-center cursor-pointer justify-center gap-3 whitespace-nowrap rounded-2xl text-lg font-bold transition-all focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 p-3 bg-primary text-primary-foreground hover:bg-primary/90 hover:-translate-y-1 shadow-lg hover:shadow-xl active:scale-95"
      >
        <span class="text-2xl">ðŸš€</span>
        Zaczynamy
      </a>

      <a
        href="/history-list"
        class="w-46 inline-flex items-center cursor-pointer justify-center gap-3 whitespace-nowrap rounded-2xl text-base font-semibold transition-all focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 px-6 py-3 bg-background text-primary hover:bg-muted border-2 border-primary shadow-sm hover:shadow-md active:scale-95"
      >
        <span class="text-xl">ðŸ“š</span>
        Twoje rozmowy
      </a>
    </div>
  </div>
</div>

<script>
  /* eslint-disable prettier/prettier */

  const $ = (id: string) => document.getElementById(id);

  const showWelcomeSection = (userName: string) => {
    const nameDisplay = $("name-display");
    const homeContent = $("home-content");
    if (nameDisplay) nameDisplay.textContent = userName;
    if (homeContent) homeContent.classList.replace("hidden", "flex");
  };

  const checkTokenStatus = async () => {
    try {
      const response = await fetch("/api/token-status");
      const data = await response.json();
      if (data.success && data.isBlocked) showBlockedMessage(data.message);
    } catch (error) {
      console.error("Error checking token status:", error);
    }
  };

  const showBlockedMessage = (message: string) => {
    const blockedMessage = $("blocked-message");
    const blockedMessageText = $("blocked-message-text");
    const startButton = $("start-button") as HTMLAnchorElement | null;

    if (blockedMessage && blockedMessageText) {
      blockedMessageText.textContent = message;
      blockedMessage.classList.remove("hidden");
    }

    if (startButton) {
      startButton.removeAttribute("href");
      startButton.setAttribute("aria-disabled", "true");
      startButton.classList.remove(
        "bg-primary",
        "hover:bg-primary/90",
        "hover:-translate-y-1",
        "hover:shadow-xl",
        "active:scale-95",
        "cursor-pointer"
      );
      startButton.classList.add("bg-muted", "text-muted-foreground", "cursor-not-allowed", "opacity-60");
      startButton.onclick = (e) => e.preventDefault();
    }
  };

  const initHome = () => {
    const storedName = localStorage.getItem("userName");
    if (storedName) showWelcomeSection(storedName);
    checkTokenStatus();
  };

  const runWhenIdle = (callback: IdleRequestCallback) =>
    "requestIdleCallback" in window ? window.requestIdleCallback(callback, { timeout: 2000 }) : setTimeout(callback, 1);

  runWhenIdle(initHome);
  document.addEventListener("astro:page-load", () => runWhenIdle(initHome));

  window.addEventListener("nameUpdated", (event) => {
    const { name } = (event as CustomEvent).detail ?? {};
    if (name) showWelcomeSection(name);
  });

  window.addEventListener("nameInputModalState", (event) => {
    const homeContent = $("home-content");
    const { isOpen } = (event as CustomEvent).detail ?? {};
    if (homeContent) homeContent.toggleAttribute("inert", isOpen);
  });
</script>
