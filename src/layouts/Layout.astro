---
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title?: string;
}

const { title = "Tutor AI" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />
    <script is:inline>
      // Service Worker Registration (production only, disabled in dev)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            const registration = await navigator.serviceWorker.register("/sw.js", { scope: "/" });
            console.log("✅ SW registered:", registration.scope);
          } catch (error) {
            // Silent fail - SW not available (normal in dev mode)
          }
        });
      }
    </script>
  </head>
  <body>
    <slot />

    <!-- Offline Indicator (Pure HTML + JS) -->
    <div
      id="offline-indicator"
      class="fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-md hidden"
      transition:persist
    >
      <div class="rounded-lg border border-red-200 bg-red-50 text-red-900 shadow-lg p-4">
        <div class="flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path d="M12 20h.01"></path>
            <path d="M8.5 16.5a5 5 0 0 1 7 0"></path>
            <path d="M2 8.82a15 15 0 0 1 20 0"></path>
            <line x1="2" x2="22" y1="2" y2="22"></line>
          </svg>
          <p class="text-sm">Jesteś offline. Niektóre funkcje mogą być niedostępne.</p>
        </div>
      </div>
    </div>

    <script is:inline>
      // Offline Indicator Logic - ensure event listeners are added only once
      (function () {
        function updateOfflineStatus() {
          const indicator = document.getElementById("offline-indicator");
          if (!indicator) return;

          if (navigator.onLine) {
            indicator.classList.add("hidden");
          } else {
            indicator.classList.remove("hidden");
          }
        }

        // If already initialized, just update status and exit
        if (window.__offlineIndicatorInitialized) {
          updateOfflineStatus();
          return;
        }
        window.__offlineIndicatorInitialized = true;

        // Make function globally available
        window.updateOfflineStatus = updateOfflineStatus;

        // Update on initial load
        updateOfflineStatus();

        // Update on online/offline events (added only once)
        window.addEventListener("online", updateOfflineStatus);
        window.addEventListener("offline", updateOfflineStatus);

        // Re-check after View Transitions navigation
        document.addEventListener("astro:page-load", updateOfflineStatus);
        document.addEventListener("astro:after-swap", updateOfflineStatus);

        // Handle back-forward cache (bfcache) - triggered when navigating back/forward
        window.addEventListener("pageshow", updateOfflineStatus);

        // Handle visibility change (when tab becomes visible again)
        document.addEventListener("visibilitychange", function () {
          if (document.visibilityState === "visible") {
            updateOfflineStatus();
          }
        });
      })();
    </script>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
